# =============================================================================
# Configuração do Supervisor para o processador de fila do Viper
# 
# ARQUIVO: /etc/supervisor/conf.d/nitroleads-queue.conf
#
# Este arquivo configura o worker que processa requisições de QSA (sócios)
# via API interna do Viper usando Playwright para autenticação.
#
# IMPORTANTE: O LD_LIBRARY_PATH é OBRIGATÓRIO para que o Playwright/Chromium
# encontre as bibliotecas do sistema (libatk, libnss, etc.)
# =============================================================================

[program:nitroleads-queue]
# Comando para executar o processador de fila
command=/home/nitroleads/apps/nitroleads/venv/bin/python /home/nitroleads/apps/nitroleads/manage.py process_viper_queue

# Diretório de trabalho (IMPORTANTE: auth_bot.py e viper_tokens.json estão aqui)
directory=/home/nitroleads/apps/nitroleads

# Usuário que executa o processo
user=nitroleads

# Iniciar automaticamente quando o supervisor iniciar
autostart=true

# Reiniciar automaticamente se o processo morrer
autorestart=true

# Arquivos de log
stderr_logfile=/home/nitroleads/logs/nitroleads/viper_queue_error.log
stdout_logfile=/home/nitroleads/logs/nitroleads/viper_queue.log

# Tamanho máximo dos arquivos de log (10MB)
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB

# Manter 5 backups dos logs
stderr_logfile_backups=5
stdout_logfile_backups=5

# Tempo máximo de espera ao parar o processo (10 minutos para processar requisição atual)
stopwaitsecs=600

# Matar todo o grupo de processos ao parar
killasgroup=true

# Prioridade (menor número = inicia primeiro)
priority=998

# =============================================================================
# VARIÁVEIS DE AMBIENTE - CRÍTICO!
# =============================================================================
# 
# DJANGO_SETTINGS_MODULE: Necessário para o Django funcionar
# LD_LIBRARY_PATH: OBRIGATÓRIO para Playwright/Chromium encontrar bibliotecas
# PLAYWRIGHT_BROWSERS_PATH: Caminho para os browsers do Playwright
#
environment=DJANGO_SETTINGS_MODULE="lead_extraction.settings",LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu",PLAYWRIGHT_BROWSERS_PATH="/home/nitroleads/.cache/ms-playwright"

