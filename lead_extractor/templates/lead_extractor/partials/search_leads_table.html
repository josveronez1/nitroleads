{% load phone_filters %}
<div class="table-responsive">
    <table class="table table-sm table-hover">
        <thead>
            <tr>
                <th class="partners-checkbox-header" id="partners-checkbox-header-{{ search.id }}" style="display: none !important; width: 0 !important; padding: 0 !important; border: none !important; visibility: hidden !important;">
                    <input type="checkbox" id="select-all-partners-{{ search.id }}" 
                           onchange="if(document.getElementById('searchFullscreenBody')) { toggleAllPartnersLeadsInModal({{ search.id }}); } else { toggleAllPartnersLeads({{ search.id }}); }"
                           style="display: none !important;">
                </th>
                <th>Empresa</th>
                <th>CNPJ</th>
                <th>Endereço</th>
                <th>Contatos</th>
                <th>Sócios</th>
                <th class="lead-expand-cell"></th>
            </tr>
        </thead>
        <tbody>
            {% for item in display_leads %}
            {% with lead=item.lead lead_access=item.lead_access %}
            {% with phones_all=lead.viper_data|get_phones emails_all=lead.viper_data|get_emails %}
            {% with phones_first=phones_all|slice_list:2 emails_first=emails_all|slice_list:2 phones_rest=phones_all|slice_list_rest:2 emails_rest=emails_all|slice_list_rest:2 %}
            <tr class="lead-row" id="lead-row-{{ lead.id }}">
                <td class="partners-checkbox-cell" id="partners-checkbox-{{ lead.id }}" style="display: none !important; width: 0 !important; padding: 0 !important; border: none !important; visibility: hidden !important;">
                    <input type="checkbox" class="partner-lead-checkbox" 
                           data-lead-id="{{ lead.id }}" 
                           data-search-id="{{ search.id }}"
                           {% if lead_access and lead_access.enriched_at and lead.viper_data.socios_qsa and lead.viper_data.socios_qsa.socios %}disabled{% else %}checked{% endif %}
                           onchange="updatePartnersCost({{ search.id }})"
                           style="display: none !important;">
                </td>
                <td>{{ lead.name }}</td>
                <td>{{ lead.cnpj|default:"-" }}</td>
                <td>
                    <div class="lead-address lead-address-compact" title="{{ lead.address|default:'' }}">{{ lead.address|default:"-" }}</div>
                </td>
                <td>
                    <div class="lead-contacts-compact">
                        {% if lead.viper_data %}
                            {% for phone in phones_first %}
                            <div class="badge bg-light text-dark mb-1">{{ phone|format_phone }}</div>
                            {% endfor %}
                            {% for email in emails_first %}
                            <div class="badge bg-light text-dark mb-1"><i class="fas fa-envelope me-1"></i>{{ email }}</div>
                            {% endfor %}
                            {% if not phones_first and not emails_first %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted small">-</span>
                        {% endif %}
                    </div>
                    {% if lead.viper_data %}
                    <div class="lead-contacts-more lead-more">
                        {% for phone in phones_rest %}
                        <div class="badge bg-light text-dark mb-1">{{ phone|format_phone }}</div>
                        {% endfor %}
                        {% for email in emails_rest %}
                        <div class="badge bg-light text-dark mb-1"><i class="fas fa-envelope me-1"></i>{{ email }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </td>
                <td id="partners-cell-{{ lead.id }}">
                    {% if lead_access and lead_access.enriched_at and lead.viper_data.socios_qsa and lead.viper_data.socios_qsa.socios %}
                        <div class="lead-partners-wrap">
                        <div class="partners-list" id="partners-list-{{ lead.id }}">
                            {% for socio in lead.viper_data.socios_qsa.socios %}
                            <div class="socio-item mb-2" data-socio-cpf="{{ socio.DOCUMENTO }}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <strong class="small">{{ socio.NOME|default:"N/A" }}</strong>
                                        <span class="text-muted small ms-1">({{ socio.CARGO|default:"Sócio" }})</span>
                                        {% if socio.DOCUMENTO %}
                                        <br><span class="text-muted small">CPF: {{ socio.DOCUMENTO }}</span>
                                        {% endif %}
                                    </div>
                                    {% if socio.DOCUMENTO %}
                                    <input type="checkbox" class="cpf-checkbox ms-2" 
                                           data-cpf="{{ socio.DOCUMENTO }}"
                                           data-lead-id="{{ lead.id }}"
                                           data-socio-name="{{ socio.NOME|default:"N/A" }}"
                                           id="cpf-{{ lead.id }}-{{ forloop.counter }}"
                                           {% if socio.cpf_enriched and socio.cpf_data %}disabled{% endif %}
                                           style="display: none;">
                                    {% endif %}
                                </div>
                                {% if socio.cpf_enriched and socio.cpf_data %}
                                <div class="mt-1 cpf-data">
                                    {% if socio.cpf_data.dados_gerais.nome %}
                                    <div class="small text-muted"><i class="fas fa-user me-1"></i>{{ socio.cpf_data.dados_gerais.nome }}</div>
                                    {% endif %}
                                    {% for phone_info in socio.cpf_data|get_unique_phones %}
                                        {% if phone_info.type == 'fixo' %}
                                        <span class="badge bg-success me-1"><i class="fas fa-phone me-1"></i>{{ phone_info.phone }}</span>
                                        {% elif phone_info.type == 'movel' %}
                                        <span class="badge bg-success me-1"><i class="fas fa-mobile-alt me-1"></i>{{ phone_info.phone }}</span>
                                        {% elif phone_info.type == 'whatsapp' %}
                                        <span class="badge bg-success me-1"><i class="fab fa-whatsapp me-1"></i>{{ phone_info.phone }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    {% for email in socio.cpf_data.emails %}
                                        {% if email %}
                                        <span class="badge bg-info me-1"><i class="fas fa-envelope me-1"></i>{{ email }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% if lead.viper_data|has_unenriched_partners %}
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <button class="btn btn-sm btn-outline-primary" 
                                    type="button"
                                    onclick="toggleCpfSelection({{ lead.id }})"
                                    id="search-cpf-btn-{{ lead.id }}">
                                <i class="fas fa-search"></i> Buscar informações dos sócios
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    type="button"
                                    onclick="cancelCpfSelection({{ lead.id }})"
                                    id="cancel-cpf-btn-{{ lead.id }}"
                                    style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endif %}
                        </div>
                    {% else %}
                        <div class="blurred-partners">
                            <div class="blurred-name">{% cycle "Carlos Silva" "Fernanda Lima" "Ricardo Alves" %}</div>
                            <div class="blurred-name">{% cycle "Ana Paula Santos" "Paulo Costa" "Juliana Mendes" %}</div>
                            <div class="blurred-name">{% cycle "Roberto Oliveira" "Mariana Souza" "Bruno Ferreira" %}</div>
                        </div>
                    {% endif %}
                </td>
                <td class="lead-expand-cell">
                    <button type="button" class="lead-expand-btn" aria-label="Expandir" onclick="var tr=this.closest('tr');if(tr)tr.classList.toggle('lead-row-expanded');return false;"><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-up"></i></button>
                </td>
            </tr>
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>
