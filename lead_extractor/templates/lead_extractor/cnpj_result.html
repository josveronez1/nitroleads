{% extends "lead_extractor/base.html" %}
{% load phone_filters %}

{% block title %}Resultado da Busca por CNPJ - NitroLeads{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Resultado da Busca por CNPJ</h5>
        <a href="{% url 'simple_search' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Nova Busca
        </a>
    </div>
    <div class="card-body">
        {% if data %}
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">CNPJ</h6>
                <p class="fw-bold fs-5">{{ cnpj }}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Razão Social</h6>
                <p class="fw-bold fs-5">{{ data.razao_social|default:"-" }}</p>
            </div>
        </div>

        <hr>

        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Nome Fantasia</h6>
                <p>{{ data.nome_fantasia|default:"-" }}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Situação</h6>
                <span class="badge {% if data.situacao == 'ATIVA' %}bg-success{% else %}bg-warning{% endif %}">
                    {{ data.situacao|default:"-" }}
                </span>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-2">Endereço</h6>
                <p>
                    {{ data.logradouro|default:"" }} {{ data.numero|default:"" }}<br>
                    {{ data.bairro|default:"" }}{% if data.bairro and data.cidade %}, {% endif %}{{ data.cidade|default:"" }} - {{ data.uf|default:"" }}<br>
                    CEP: {{ data.cep|default:"-" }}
                </p>
            </div>
        </div>

        {% if data.telefones %}
        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-2">Telefones</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for phone in data|get_phones %}
                    <span class="badge bg-primary">{{ phone|format_phone }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if data.emails %}
        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-2">E-mails</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for email in data|get_emails %}
                    <span class="badge bg-info text-dark"><i class="fas fa-envelope me-1"></i>{{ email }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if data.socios_qsa and data.socios_qsa.socios %}
        <hr>
        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-3">Sócios / Decisores</h6>
                <div class="partners-list" id="partners-list-{{ temp_lead_id }}">
                    {% for socio in data.socios_qsa.socios %}
                    <div class="socio-item mb-2 border rounded p-3" data-socio-cpf="{{ socio.DOCUMENTO|default:socio.CPF }}">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <strong class="small">{{ socio.NOME|default:"N/A" }}</strong>
                                <span class="text-muted small ms-1">({{ socio.CARGO|default:"Sócio" }})</span>
                                {% if socio.DOCUMENTO or socio.CPF %}
                                <br><span class="text-muted small">CPF: {{ socio.DOCUMENTO|default:socio.CPF }}</span>
                                {% endif %}
                            </div>
                            {% if socio.DOCUMENTO or socio.CPF %}
                            <input type="checkbox" class="cpf-checkbox ms-2" 
                                   data-cpf="{{ socio.DOCUMENTO|default:socio.CPF }}"
                                   data-lead-id="{{ temp_lead_id }}"
                                   data-socio-name="{{ socio.NOME|default:"N/A" }}"
                                   data-cnpj="{{ cnpj }}"
                                   id="cpf-{{ temp_lead_id }}-{{ forloop.counter }}"
                                   style="display: none;">
                            {% endif %}
                        </div>
                        {% if socio.cpf_enriched and socio.cpf_data %}
                        <div class="mt-2 cpf-data">
                            {% if socio.cpf_data.dados_gerais.nome %}
                            <div class="small text-muted mb-1"><i class="fas fa-user me-1"></i>{{ socio.cpf_data.dados_gerais.nome }}</div>
                            {% endif %}
                            {% for phone in socio.cpf_data.telefones_fixos %}
                                {% if phone %}
                                <span class="badge bg-success me-1"><i class="fas fa-phone me-1"></i>{{ phone }}</span>
                                {% endif %}
                            {% endfor %}
                            {% for phone in socio.cpf_data.telefones_moveis %}
                                {% if phone %}
                                <span class="badge bg-success me-1"><i class="fas fa-mobile-alt me-1"></i>{{ phone }}</span>
                                {% endif %}
                            {% endfor %}
                            {% for phone in socio.cpf_data.whatsapps %}
                                {% if phone %}
                                <span class="badge bg-success me-1"><i class="fab fa-whatsapp me-1"></i>{{ phone }}</span>
                                {% endif %}
                            {% endfor %}
                            {% for email in socio.cpf_data.emails %}
                                {% if email %}
                                <span class="badge bg-info me-1"><i class="fas fa-envelope me-1"></i>{{ email }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% if data|has_unenriched_partners %}
                <div class="d-flex align-items-center gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary" 
                            type="button"
                            onclick="toggleCpfSelection('{{ temp_lead_id }}')"
                            id="search-cpf-btn-{{ temp_lead_id }}">
                        <i class="fas fa-search"></i> Buscar informações dos sócios
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            type="button"
                            onclick="cancelCpfSelection('{{ temp_lead_id }}')"
                            id="cancel-cpf-btn-{{ temp_lead_id }}"
                            style="display: none;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            Créditos disponíveis: <strong>{{ available_credits }}</strong>
        </div>

        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Nenhum dado encontrado para este CNPJ.
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para resultados de busca por CPF -->
<div class="modal fade" id="cpfResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultados da Busca por CPF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cpfResultContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Função auxiliar para obter token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function getCsrfToken() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput && csrfInput.value) {
            return csrfInput.value;
        }
        const csrfCookie = getCookie('csrftoken');
        if (csrfCookie) {
            return csrfCookie;
        }
        console.error('Token CSRF não encontrado!');
        return null;
    }

    // Função para mostrar alertas
    function showAlert(message, type = 'info') {
        alert(message); // Simplificado - pode usar modais se preferir
    }
    
    function showSuccess(message) {
        alert(message); // Simplificado - pode usar modais se preferir
    }
    
    function showError(message) {
        alert(message); // Simplificado - pode usar modais se preferir
    }

    // Função para expandir/contrair seleção de CPFs
    function toggleCpfSelection(leadId) {
        const checkboxes = document.querySelectorAll(`#partners-list-${leadId} .cpf-checkbox`);
        const searchBtn = document.getElementById(`search-cpf-btn-${leadId}`);
        const cancelBtn = document.getElementById(`cancel-cpf-btn-${leadId}`);
        
        if (checkboxes.length === 0) {
            showAlert('Nenhum sócio com CPF encontrado para este lead.', 'warning');
            return;
        }
        
        if (checkboxes[0].style.display === 'none' || !checkboxes[0].style.display) {
            // Mostrar checkboxes
            checkboxes.forEach(cb => {
                cb.style.display = 'block';
                cb.checked = true;
            });
            searchBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Busca';
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
            }
        } else {
            // Buscar CPFs selecionados
            searchCpfsBatch(leadId);
        }
    }
    
    // Função para cancelar seleção de CPFs
    function cancelCpfSelection(leadId) {
        const checkboxes = document.querySelectorAll(`#partners-list-${leadId} .cpf-checkbox`);
        const searchBtn = document.getElementById(`search-cpf-btn-${leadId}`);
        const cancelBtn = document.getElementById(`cancel-cpf-btn-${leadId}`);
        
        // Ocultar checkboxes
        checkboxes.forEach(cb => {
            cb.style.display = 'none';
        });
        
        // Restaurar botão
        if (searchBtn) {
            searchBtn.innerHTML = '<i class="fas fa-search"></i> Buscar informações dos sócios';
        }
        
        // Ocultar botão cancelar
        if (cancelBtn) {
            cancelBtn.style.display = 'none';
        }
    }

    // Buscar CPFs em lote (versão simplificada para busca rápida - não salva no banco)
    function searchCpfsBatch(tempLeadId) {
        const checkboxes = document.querySelectorAll(`#partners-list-${tempLeadId} .cpf-checkbox:checked`);
        const cpfsToSearch = Array.from(checkboxes).map(cb => ({
            cpf: cb.dataset.cpf,
            socio_name: cb.dataset.socioName,
            cnpj: cb.dataset.cnpj || ''
        }));
        
        if (cpfsToSearch.length === 0) {
            showAlert('Selecione pelo menos um sócio para buscar dados por CPF.', 'warning');
            cancelCpfSelection(tempLeadId);
            return;
        }
        
        // Mostrar loading
        const searchBtn = document.getElementById(`search-cpf-btn-${tempLeadId}`);
        const originalText = searchBtn.innerHTML;
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            showError('Erro: Token CSRF não encontrado. Por favor, recarregue a página.');
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalText;
            return;
        }
        
        // Buscar cada CPF individualmente usando search_by_cpf
        let completed = 0;
        let creditsDebited = 0;
        let errors = [];
        
        cpfsToSearch.forEach((item, index) => {
            fetch('{% url "search_by_cpf" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'cpf=' + encodeURIComponent(item.cpf)
            })
            .then(response => response.json())
            .then(data => {
                completed++;
                if (data.success) {
                    creditsDebited++;
                    // Atualizar interface com os dados retornados
                    const socioItem = document.querySelector(`#partners-list-${tempLeadId} .socio-item[data-socio-cpf="${item.cpf}"]`);
                    if (socioItem && data.data) {
                        // Adicionar dados ao sócio
                        let dataDiv = socioItem.querySelector('.cpf-data');
                        if (!dataDiv) {
                            dataDiv = document.createElement('div');
                            dataDiv.className = 'mt-2 cpf-data';
                            socioItem.appendChild(dataDiv);
                        }
                        
                        dataDiv.innerHTML = '';
                        
                        // Adicionar telefones
                        if (data.data.telefones && data.data.telefones.length > 0) {
                            data.data.telefones.forEach(phone => {
                                if (phone) {
                                    const badge = document.createElement('span');
                                    badge.className = 'badge bg-success me-1';
                                    badge.innerHTML = `<i class="fas fa-phone me-1"></i>${phone}`;
                                    dataDiv.appendChild(badge);
                                }
                            });
                        }
                        
                        // Adicionar emails
                        if (data.data.emails && data.data.emails.length > 0) {
                            data.data.emails.forEach(email => {
                                if (email) {
                                    const badge = document.createElement('span');
                                    badge.className = 'badge bg-info me-1';
                                    badge.innerHTML = `<i class="fas fa-envelope me-1"></i>${email}`;
                                    dataDiv.appendChild(badge);
                                }
                            });
                        }
                    }
                } else {
                    errors.push(`Erro ao buscar CPF ${item.cpf}: ${data.error || 'Erro desconhecido'}`);
                }
                
                // Quando todas as buscas terminarem
                if (completed === cpfsToSearch.length) {
                    if (creditsDebited > 0) {
                        showSuccess(`Busca concluída! ${creditsDebited} crédito(s) debitado(s).`);
                    }
                    if (errors.length > 0) {
                        showError('Alguns CPFs não puderam ser buscados: ' + errors.join('; '));
                    }
                    
                    // Ocultar checkboxes e restaurar botão
                    cancelCpfSelection(tempLeadId);
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                completed++;
                errors.push(`Erro ao buscar CPF ${item.cpf}`);
                console.error('Erro:', error);
                
                if (completed === cpfsToSearch.length) {
                    if (creditsDebited > 0) {
                        showSuccess(`Busca concluída! ${creditsDebited} crédito(s) debitado(s).`);
                    }
                    if (errors.length > 0) {
                        showError('Alguns CPFs não puderam ser buscados: ' + errors.join('; '));
                    }
                    
                    cancelCpfSelection(tempLeadId);
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = originalText;
                }
            });
        });
    }
</script>
{% endblock %}




