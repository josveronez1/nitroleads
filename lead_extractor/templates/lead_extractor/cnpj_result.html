{% extends "lead_extractor/base.html" %}
{% load phone_filters %}

{% block title %}Resultado da Busca por CNPJ - NitroLeads{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Resultado da Busca por CNPJ</h5>
        <a href="{% url 'simple_search' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Nova Busca
        </a>
    </div>
    <div class="card-body">
        {% if data and lead %}
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">CNPJ</h6>
                <p class="fw-bold fs-5">{{ cnpj }}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Razão Social</h6>
                <p class="fw-bold fs-5">{{ data.razao_social|default:"-" }}</p>
            </div>
        </div>

        <hr>

        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Nome Fantasia</h6>
                <p>{{ data.nome_fantasia|default:"-" }}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Situação</h6>
                <span class="badge {% if data.situacao == 'ATIVA' %}bg-success{% else %}bg-warning{% endif %}">
                    {{ data.situacao|default:"-" }}
                </span>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-2">Endereço</h6>
                <p>
                    {{ data.logradouro|default:"" }} {{ data.numero|default:"" }}<br>
                    {{ data.bairro|default:"" }}{% if data.bairro and data.cidade %}, {% endif %}{{ data.cidade|default:"" }} - {{ data.uf|default:"" }}<br>
                    CEP: {{ data.cep|default:"-" }}
                </p>
            </div>
        </div>

        {% if data.telefones %}
        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-2">Telefones</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for phone in data|get_phones %}
                    <span class="badge bg-primary">{{ phone|format_phone }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if data.emails %}
        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-2">E-mails</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for email in data|get_emails %}
                    <span class="badge bg-info text-dark"><i class="fas fa-envelope me-1"></i>{{ email }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if data.socios_qsa and data.socios_qsa.socios %}
        <hr>
        <div class="row mb-4">
            <div class="col-md-12">
                <h6 class="text-muted mb-3">Sócios / Decisores</h6>
                <div class="partners-list" id="partners-list-{{ lead.id }}">
                    {% for socio in data.socios_qsa.socios %}
                    <div class="socio-item mb-2 border rounded p-3" data-socio-cpf="{{ socio.DOCUMENTO|default:'' }}">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <strong class="small">{{ socio.NOME|default:"N/A" }}</strong>
                                <span class="text-muted small ms-1">({{ socio.CARGO|default:"Sócio" }})</span>
                                {% if socio.DOCUMENTO %}
                                <br><span class="text-muted small">CPF: {{ socio.DOCUMENTO }}</span>
                                {% endif %}
                            </div>
                            {% if socio.DOCUMENTO %}
                            <input type="checkbox" class="cpf-checkbox ms-2" 
                                   data-cpf="{{ socio.DOCUMENTO }}"
                                   data-lead-id="{{ lead.id }}"
                                   data-socio-name="{{ socio.NOME|default:"N/A" }}"
                                   data-cnpj="{{ cnpj }}"
                                   id="cpf-{{ lead.id }}-{{ forloop.counter }}"
                                   style="display: none;">
                            {% endif %}
                        </div>
                        {% if socio.cpf_enriched and socio.cpf_data %}
                        <div class="mt-2 cpf-data">
                            {% if socio.cpf_data.dados_gerais.nome %}
                            <div class="small text-muted mb-1"><i class="fas fa-user me-1"></i>{{ socio.cpf_data.dados_gerais.nome }}</div>
                            {% endif %}
                            {% for phone_info in socio.cpf_data|get_unique_phones %}
                                {% if phone_info.type == 'fixo' %}
                                <span class="badge bg-success me-1"><i class="fas fa-phone me-1"></i>{{ phone_info.phone }}</span>
                                {% elif phone_info.type == 'movel' %}
                                <span class="badge bg-success me-1"><i class="fas fa-mobile-alt me-1"></i>{{ phone_info.phone }}</span>
                                {% elif phone_info.type == 'whatsapp' %}
                                <span class="badge bg-success me-1"><i class="fab fa-whatsapp me-1"></i>{{ phone_info.phone }}</span>
                                {% endif %}
                            {% endfor %}
                            {% for email in socio.cpf_data.emails %}
                                {% if email %}
                                <span class="badge bg-info me-1"><i class="fas fa-envelope me-1"></i>{{ email }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% if data|has_unenriched_partners %}
                <div class="d-flex align-items-center gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary" 
                            type="button"
                            onclick="toggleCpfSelection({{ lead.id }})"
                            id="search-cpf-btn-{{ lead.id }}">
                        <i class="fas fa-search"></i> Buscar informações dos sócios
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            type="button"
                            onclick="cancelCpfSelection({{ lead.id }})"
                            id="cancel-cpf-btn-{{ lead.id }}"
                            style="display: none;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            Créditos disponíveis: <strong>{{ available_credits }}</strong>
        </div>

        {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Erro:</strong> Não foi possível carregar os dados do CNPJ. 
            {% if not data %}
            Dados não encontrados.
            {% elif not lead %}
            Lead não encontrado.
            {% else %}
            Erro desconhecido.
            {% endif %}
            <br><br>
            <a href="{% url 'simple_search' %}" class="btn btn-sm btn-primary">Tentar novamente</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para resultados de busca por CPF -->
<div class="modal fade" id="cpfResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultados da Busca por CPF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cpfResultContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Alerta -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="alertModalHeader">
                <h5 class="modal-title" id="alertModalTitle">Aviso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertModalBody">
                <p id="alertModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Sucesso -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Sucesso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="successModalBody">
                <p id="successModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Erro -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-circle me-2"></i>Erro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="errorModalBody">
                <p id="errorModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Função auxiliar para obter token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function getCsrfToken() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput && csrfInput.value) {
            return csrfInput.value;
        }
        const csrfCookie = getCookie('csrftoken');
        if (csrfCookie) {
            return csrfCookie;
        }
        console.error('Token CSRF não encontrado!');
        return null;
    }

    // Função para mostrar alertas
    function showAlert(message, type = 'info') {
        const modal = new bootstrap.Modal(document.getElementById('alertModal'));
        const title = document.getElementById('alertModalTitle');
        const body = document.getElementById('alertModalBody');
        const header = document.getElementById('alertModalHeader');
        
        title.textContent = type === 'info' ? 'Aviso' : (type === 'warning' ? 'Atenção' : 'Informação');
        document.getElementById('alertModalMessage').textContent = message;
        
        // Ajustar cor do header
        header.className = 'modal-header';
        if (type === 'warning') {
            header.classList.add('bg-warning', 'text-dark');
        } else if (type === 'info') {
            header.classList.add('bg-info', 'text-white');
        } else {
            header.classList.add('bg-primary', 'text-white');
        }
        
        modal.show();
    }
    
    function showSuccess(message) {
        const modal = new bootstrap.Modal(document.getElementById('successModal'));
        const messageElement = document.getElementById('successModalMessage');
        // Se a mensagem já contém HTML (como <br>), usar innerHTML, senão usar textContent
        if (message.includes('<br>') || message.includes('<')) {
            messageElement.innerHTML = message;
        } else {
            messageElement.textContent = message;
        }
        modal.show();
    }
    
    function showError(message) {
        const modal = new bootstrap.Modal(document.getElementById('errorModal'));
        document.getElementById('errorModalMessage').textContent = message;
        modal.show();
    }

    // Função para expandir/contrair seleção de CPFs
    function toggleCpfSelection(leadId) {
        const checkboxes = document.querySelectorAll(`#partners-list-${leadId} .cpf-checkbox`);
        const searchBtn = document.getElementById(`search-cpf-btn-${leadId}`);
        const cancelBtn = document.getElementById(`cancel-cpf-btn-${leadId}`);
        
        if (checkboxes.length === 0) {
            showAlert('Nenhum sócio com CPF encontrado para este lead.', 'warning');
            return;
        }
        
        if (checkboxes[0].style.display === 'none' || !checkboxes[0].style.display) {
            // Mostrar checkboxes
            checkboxes.forEach(cb => {
                cb.style.display = 'block';
                cb.checked = true;
            });
            searchBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Busca';
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
            }
        } else {
            // Buscar CPFs selecionados
            searchCpfsBatch(leadId);
        }
    }
    
    // Função para cancelar seleção de CPFs
    function cancelCpfSelection(leadId) {
        const checkboxes = document.querySelectorAll(`#partners-list-${leadId} .cpf-checkbox`);
        const searchBtn = document.getElementById(`search-cpf-btn-${leadId}`);
        const cancelBtn = document.getElementById(`cancel-cpf-btn-${leadId}`);
        
        // Ocultar checkboxes
        checkboxes.forEach(cb => {
            cb.style.display = 'none';
        });
        
        // Restaurar botão
        if (searchBtn) {
            searchBtn.innerHTML = '<i class="fas fa-search"></i> Buscar informações dos sócios';
        }
        
        // Ocultar botão cancelar
        if (cancelBtn) {
            cancelBtn.style.display = 'none';
        }
    }

    // Buscar CPFs em lote usando search_cpf_batch (lead está salvo no banco)
    function searchCpfsBatch(leadId) {
        const checkboxes = document.querySelectorAll(`#partners-list-${leadId} .cpf-checkbox:checked`);
        const cpfData = Array.from(checkboxes).map(cb => ({
            lead_id: parseInt(cb.dataset.leadId),
            cpf: cb.dataset.cpf,
            socio_name: cb.dataset.socioName
        }));
        
        if (cpfData.length === 0) {
            showAlert('Selecione pelo menos um sócio para buscar dados por CPF.', 'warning');
            cancelCpfSelection(leadId);
            return;
        }
        
        // Mostrar loading
        const searchBtn = document.getElementById(`search-cpf-btn-${leadId}`);
        const originalText = searchBtn.innerHTML;
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            showError('Erro: Token CSRF não encontrado. Por favor, recarregue a página.');
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalText;
            return;
        }
        
        // Fazer requisição AJAX usando search_cpf_batch
        fetch('{% url "search_cpf_batch" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                cpfs: cpfData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualizar interface com os dados retornados
                data.results.forEach(result => {
                    const socioItem = document.querySelector(`#partners-list-${leadId} .socio-item[data-socio-cpf="${result.cpf}"]`);
                    if (socioItem && result.cpf_data) {
                        // Adicionar dados ao sócio
                        let dataDiv = socioItem.querySelector('.cpf-data');
                        if (!dataDiv) {
                            dataDiv = document.createElement('div');
                            dataDiv.className = 'mt-2 cpf-data';
                            socioItem.appendChild(dataDiv);
                        }
                        
                        dataDiv.innerHTML = '';
                        
                        // Adicionar nome se disponível
                        if (result.cpf_data.dados_gerais && result.cpf_data.dados_gerais.nome) {
                            const nomeDiv = document.createElement('div');
                            nomeDiv.className = 'small text-muted mb-1';
                            nomeDiv.innerHTML = `<i class="fas fa-user me-1"></i>${result.cpf_data.dados_gerais.nome}`;
                            dataDiv.appendChild(nomeDiv);
                        }
                        
                        // Função para normalizar telefone (remover caracteres não numéricos)
                        const normalizePhone = (phone) => {
                            if (!phone) return null;
                            return String(phone).replace(/\D/g, '');
                        };
                        
                        // Coletar telefones únicos, priorizando WhatsApp
                        const phonesDict = {};
                        
                        // Processar WhatsApp primeiro (maior prioridade)
                        (result.cpf_data.whatsapps || []).forEach(phone => {
                            if (phone) {
                                const normalized = normalizePhone(phone);
                                if (normalized) {
                                    phonesDict[normalized] = {phone: phone, type: 'whatsapp'};
                                }
                            }
                        });
                        
                        // Processar móveis (menor prioridade que WhatsApp)
                        (result.cpf_data.telefones_moveis || []).forEach(phone => {
                            if (phone) {
                                const normalized = normalizePhone(phone);
                                if (normalized && !phonesDict[normalized]) {
                                    phonesDict[normalized] = {phone: phone, type: 'movel'};
                                }
                            }
                        });
                        
                        // Processar fixos (menor prioridade)
                        (result.cpf_data.telefones_fixos || []).forEach(phone => {
                            if (phone) {
                                const normalized = normalizePhone(phone);
                                if (normalized && !phonesDict[normalized]) {
                                    phonesDict[normalized] = {phone: phone, type: 'fixo'};
                                }
                            }
                        });
                        
                        // Renderizar telefones únicos
                        Object.values(phonesDict).forEach(phoneInfo => {
                            let icon = 'fas fa-phone';
                            if (phoneInfo.type === 'movel') {
                                icon = 'fas fa-mobile-alt';
                            } else if (phoneInfo.type === 'whatsapp') {
                                icon = 'fab fa-whatsapp';
                            }
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success me-1';
                            badge.innerHTML = `<i class="${icon} me-1"></i>${phoneInfo.phone}`;
                            dataDiv.appendChild(badge);
                        });
                        
                        // Adicionar emails
                        if (result.cpf_data.emails) {
                            result.cpf_data.emails.forEach(email => {
                                if (email) {
                                    const badge = document.createElement('span');
                                    badge.className = 'badge bg-info me-1';
                                    badge.innerHTML = `<i class="fas fa-envelope me-1"></i>${email}`;
                                    dataDiv.appendChild(badge);
                                }
                            });
                        }
                    }
                });
                
                showSuccess(`Busca concluída! ${data.credits_debited} crédito(s) debitado(s).`);
                
                // Ocultar checkboxes e restaurar botão
                cancelCpfSelection(leadId);
                
                // Recarregar página após alguns segundos para atualizar dados do servidor
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showError('Erro ao buscar CPFs: ' + (data.error || 'Erro desconhecido'));
                searchBtn.disabled = false;
                searchBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('Erro ao buscar quadro societário. Tente novamente.');
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalText;
        });
    }
</script>
{% endblock %}




